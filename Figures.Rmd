---
title: "Simulation figures"
author: "Hanne Oberman"
date: "7-10-2021"
output: html_document
---

```{r setup, include=FALSE}
# packages
library(dplyr)
library(ggplot2)

# figure labels and colors
pred_lab <- paste0("X", 1:10)
pred_col <- c("#1269b0", "#7c1315") %>% setNames(c("Observed", "Missing"))
meth_lab <- c("CMI+FLR", "SDI+FLR", "MDI+FLR", "BOS+FLR", "CMI+RF", "SDI+RF", "MDI+RF", "BOS+RF", "SS+RF")
meth_col <- c("#1269b0", "#81c454") %>% setNames(c("FLR", "RF"))
miss_lab <- c("CMI", "SDI", "MDI", "BOS", "SS")
plot_lab <- c(miss_lab[-5], miss_lab)

```

# Data Generating Mechanism

```{r dgm}
# load data
corr <- readRDS("Data/correlations.RDS")
coef <- readRDS("Data/coefficients.RDS")
patt <- readRDS("Data/missing_data_pattern.RDS")

# plot
ggplot(corr, aes(x = pred, y = name, fill = value, label = text)) +
  geom_tile() +
  geom_text() +
  scale_x_discrete(limits = pred_lab) +
  scale_y_discrete(limits = rev(pred_lab)) +
  scale_fill_viridis_c(na.value = 0, alpha = .6, name = "Correlation") +
  labs(x = "", y = "") +
  theme_classic() 

ggplot(coef, aes(x = pred, y = type, fill = value, label = text)) +
  geom_tile() +
  geom_text() +
  scale_y_discrete(limits = c("Y*", "Y")) +
  scale_fill_viridis_c(na.value = 0, alpha = .6, name = "Coefficient") +
  labs(x = "", y = "") +
  theme_classic() 

ggplot(patt, aes(x = name, y = row, fill = value)) +
  geom_tile(color = "black") +
  scale_x_discrete(limits = pred_lab) +
  scale_y_discrete(limits = 1:3, labels = paste("Pattern", 3:1)) +
  scale_fill_manual(values = pred_col, name = "Predictor value") +
  labs(x = "", y = "") +
  theme_minimal() 
```

# Reference Performance

```{r reference}
# load data
ref_perf <- readRDS("Results/reference_performance.RDS")

# table
mean_ref <- ref_perf %>% 
  group_by(method) %>% 
  summarise(auc = mean(auc), int = mean(intercept), slo = mean(slope))

# plot
ref_perf %>% tidyr::pivot_longer(cols = everything()[-1]) %>% 
  mutate(name = factor(name, levels = c("intercept", "slope", "auc"), labels = c( "Intercept", "Slope","AUC"), ordered = TRUE)) %>% 
  ggplot(aes(x = value, y = method, fill = method)) +
  geom_boxplot() +
  facet_wrap(~name, scales = "free") +
  scale_fill_manual(values = meth_col) +
  theme_classic() 
```

On complete data, the flexible logistics regression has slightly better performance than the random forest:

- FLR intercept closer to 0 than RF (`r mean_ref$int %>% round(.,3)`, respectively);

- FLR slope *not* closer to 1 than RF (`r mean_ref$slo %>% round(.,3)`, respectively);

- FLR C-index higher than RF (`r mean_ref$auc %>% round(.,3)`, respectively).


# Simulation Results

```{r results}
# load data
perf <- readRDS("Results/performance.RDS")

# plot function
plot_perf <- function(all_perf, metric = "RMSE"){
  all_perf[, c("Method", "Model", "Strategy", metric)] %>% 
  setNames(c("Method", "Model", "Strategy", "metric")) %>% 
  ggplot(aes(x = metric, y = Method, fill = Model)) +
  geom_boxplot() +
  scale_y_discrete(limits = rev(meth_lab), labels = plot_lab) +
  scale_fill_manual(values = meth_col) +
  theme_classic() +
  labs(x = metric, y = "Missing data strategy")
}
```


## Calibration

```{r calibration}
plot_perf(perf, "Intercept")
plot_perf(perf, "Slope")
```
Aim: Intercept should be zero, slope should be one.

Summary:

- Best performance in terms of intercept: BOS+FLR, MDI+RF and MDI+FLR

- Worst performance in terms of intercept: SDI+FLR, SDI+RF, BOS+RF, SS+RF

- Best performance in terms of slope: BOS+FLR, CMI+FLR, MDI+RF and MDI+FLR

- Terrible performance in terms of slope: SDI+FLR, SDI+RF, BOS+RF (SS+RF = mixed bag)


## RMSE

```{r RMSE}
plot_perf(perf, "RMSE")
```
Aim: As close to zero as possible. Method with the lowest RMSE has best recovered the original probability of Y.

Summary:

- Best performance in terms of RMSE: MDI+RF, BOS+FLR, MDI+FLR, CMI+FLR

- Worst performance in terms of RMSE: SDI+FLR, SDI+RF, SS+RF (very wide range) and BOS+RF 


## Brier score

```{r brier}
plot_perf(perf, "Brier")
```

Aim: As close to zero as possible. Method with the lowest Brier score has best recovered the original observed Y.

Summary:

- Best performance in terms of Brier score: MDI+RF, BOS+FLR, MDI+FLR, CMI+FLR

- Worst performance in terms of Brier score: SDI+FLR, SDI+RF, SS+RF (wide range) and BOS+RF 


## AUC

```{r auc, message=FALSE, warning=FALSE}
plot_perf(perf, "AUC")
```
Aim: As close to one as possible. Method with the highest AUC has the best discrimination between patients with and without the outcome (Y).

Summary:

- Best performance in terms of AUC: MDI+RF, BOS+FLR, CMI+FLR, MDI+FLR (CMI+RF on average good, but very wide range)

- Worst performance in terms of AUC: SDI+FLR, SDI+RF, BOS+RF, SS+RF (wide range) 


## Full results

```{r all}
# make wide format long
perf_long <- perf %>% 
  tidyr::pivot_longer(cols = everything()[-c(1, 7, 8)], names_to = "Metric", values_to = "Performance") %>% 
  mutate(
    Metric = factor(Metric, levels = c("Intercept", "Slope", "AUC", "RMSE", "Brier"), ordered = TRUE)
    )

# plot
ggplot(perf_long, aes(y = Method, x = Performance, fill = Model)) +
  geom_boxplot() +
  scale_y_discrete(limits = rev(meth_lab), labels = rev(c(miss_lab[-5], miss_lab))) +
  facet_wrap(~Metric, scales = "free", nrow = 1) +
  scale_fill_manual(values = meth_col) +
  theme_classic()

```

# Table

## Average performance

```{r average}
(perf_table <- perf %>% 
  select(-Method) %>% 
  group_by(Model, Strategy) %>% 
  summarise(across(everything(), mean),
            across(everything(), round, 3))) 

perf_table %>% 
   write.table(file = "Results/perf.csv", sep = ";", row.names = FALSE)

# kableExtra::kable(perf_table, 
#                   format = "latex",
#                   booktabs = TRUE,
#                   align = c("l", "l", rep("c", 5)),
# )
```

