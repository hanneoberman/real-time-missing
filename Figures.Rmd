---
title: "Simulation figures"
author: "Hanne Oberman"
date: "7-10-2021"
output: html_document
---

```{r setup, include=FALSE}
# packages
library(dplyr)
library(ggplot2)

# load simulation output
results <- readRDS("output.RDS")$results
# results <- readRDS("output.RDS") %>% .$results %>% purrr::map_dfr(., ~{.x %>% .[1:20000, ] %>% tidyr::pivot_longer(cols = everything()[-c(1:2)], names_to = "method", values_to = "Y_pred", names_prefix = "Y_pred_")}) %>% cbind(sim = rep(1:1000, each = 20000*8)) %>%  as_tibble()
gc()

# add shortcuts
meth <- names(results[[1]])[-c(1:2)]
meth_lab <- c("CMI+FLR", "SDI+FLR", "MDI+FLR", "CMI+RF", "SDI+RF", "MDI+RF", "BOS+FLR", "BOS+RF")
meth_col <- c("#1269b0", "#81c454") %>% setNames(c("FLR", "RF"))
pred_lab <- paste0("X", 1:10)
pred_col <- c("#1269b0", "#7c1315") %>% setNames(c("Observed", "Missing"))
```

# Visualize DGM

## Variables

```{r dgm}
# load data and names
dgm <- readRDS("output.RDS") %>% .$DGM

dgm$varcov %>% 
  cov2cor() %>% 
  ggcorrplot::ggcorrplot(lab = TRUE, type = "upper")

corr <- dgm$varcov %>% 
  cov2cor() %>% 
  cbind(pred_lab, .) %>% 
  as.data.frame() %>% 
  setNames(c("pred", pred_lab)) %>% 
  tidyr::pivot_longer(cols = everything()[-1]) %>% 
  mutate(value = as.numeric(value),
         text = round(value, 2))

corr[corr$pred==corr$name, "value"] <- NA
# corr[corr$pred==corr$name, "text"] <- pred_lab
corr[c(11, 21, 22, 31:33, 41:44, 51:55, 61:66, 71:77, 81:88, 91:99), "value"] <- NA
corr[c(11, 21, 22, 31:33, 41:44, 51:55, 61:66, 71:77, 81:88, 91:99), "text"] <- NA

ggplot(corr, aes(x = pred, y = name, fill = value, label = text)) +
  geom_tile() +
  geom_text() +
  scale_x_discrete(limits = pred_lab) +
  scale_y_discrete(limits = rev(pred_lab)) +
  scale_fill_viridis_c(na.value = 0, alpha = .6, name = "Correlation") +
  labs(x = "", y = "") +
  theme_classic() 

coef <- data.frame(
  value = dgm$betas, 
  pred = factor(pred_lab, levels = pred_lab), 
  type = c(rep("Y", 10), rep("Y*", 10))) %>% 
  mutate(text = round(value, 2))

ggplot(coef, aes(x = pred, y = type, fill = value, label = text)) +
  geom_tile() +
  geom_text() +
  scale_y_discrete(limits = c("Y*", "Y")) +
  scale_fill_viridis_c(na.value = 0, alpha = .6, name = "Coefficient") +
  labs(x = "", y = "") +
  theme_classic() 

```

## Missingness

```{r}
patterns <- tibble(
  rownr = 1:5, 
  X = rep(1, 5), 
  Y = c(1,1,1,0, 0), 
  Z = c(1, rep(0,4))) %>% 
  tidyr::pivot_longer(cols = c(X, Y, Z)) %>%
  mutate(across(everything(), as.factor))

patt <- dgm$miss_pat[c(4,8,12), -c(1:2)] %>% 
  as.data.frame() %>% 
  cbind(row = 1:3, .) %>% 
  tidyr::pivot_longer(cols = everything()[-1]) %>% 
  mutate(value = factor(value, levels = c(0,1), labels = c("Missing", "Observed")))

# patt2 <- dgm$miss_pat[, -c(1:2)] %>% 
#   as.data.frame() %>% 
#   cbind(row = 1:12, 
#         type = c("Left", "Middle", "Right", "Tails"),
#         .)
  
ggplot(patt, aes(x = name, y = row, fill = value)) +
  geom_tile(color = "black") +
  scale_x_discrete(limits = pred_lab) +
  scale_y_discrete(limits = 3:1, labels = NULL) +
  scale_fill_manual(values = pred_col, name = "Predictor") +
  labs(x= "", y = "") +
  theme_minimal() 

```


# Visualize results

## Calibration

```{r calibration}
cali <- purrr::map_dfr(results, function(.i){
  purrr::map_dfr(meth, ~{lm(.i$Y_prob ~ .i[ , .x])$coefficients %>% c(method = .x, .)}) %>% setNames(c("Method", "Intercept", "Slope"))
}) %>% mutate(Intercept = as.numeric(Intercept), 
              Slope = as.numeric(Slope),
              Analysis = case_when(stringr::str_detect(Method, "log")~"FLR", TRUE~"RF"),
              Method = factor(Method, levels = c(meth))
              )

cali %>% 
  ggplot(aes(x = Method, y = Intercept, fill = Analysis)) +
  geom_hline(yintercept = 0, color = "grey") +
  geom_boxplot() +
  scale_x_discrete(breaks = meth, labels = meth_lab) +
  scale_fill_manual(values = meth_col) +
  theme_classic() 

cali %>% 
  ggplot(aes(x = Method, y = Slope, fill = Analysis)) +
  geom_hline(yintercept = 1, color = "grey") +
  geom_boxplot() +
  scale_x_discrete(breaks = meth, labels = meth_lab) +
  scale_fill_manual(values = meth_col) +
  theme_classic() 

# ggplot(results) +
#   geom_smooth(aes(x = Y_pred, y = Y_prob), method = "lm") +
#   facet_wrap(~method)
```


## RMSE

```{r RMSE}
rmse <- purrr::map_dfr(results, function(.i){purrr::map_dfc(.i[,-c(1:2)], ~{sqrt(mean((.x - .i$Y_prob)^2))})}) %>% 
  tidyr::pivot_longer(cols = everything(), names_to = "Method", values_to = "RMSE") %>% 
  mutate(Analysis = case_when(stringr::str_detect(Method, "log")~"FLR", TRUE~"RF"),
         Method = factor(Method, levels = c(meth))
        )

rmse %>% 
  ggplot(aes(x = Method, y = RMSE, fill = Analysis)) +
  geom_boxplot() +
  scale_x_discrete(breaks = meth, labels = meth_lab) +
  scale_fill_manual(values = meth_col) +
  theme_classic()
```

## Brier score

```{r brier}
brier <- purrr::map_dfr(results, function(.i){purrr::map_dfc(.i[,-c(1:2)], ~{mean((.x - .i$Y_true)^2)})}) %>% 
  tidyr::pivot_longer(cols = everything(), names_to = "Method", values_to = "Brier") %>% 
  mutate(Analysis = case_when(stringr::str_detect(Method, "log")~"FLR", TRUE~"RF"),
         Method = factor(Method, levels = c(meth))
        )

brier %>% 
  ggplot(aes(x = Method, y = Brier, fill = Analysis)) +
  geom_boxplot() +
  scale_x_discrete(breaks = meth, labels = meth_lab) +
  scale_fill_manual(values = meth_col) +
  theme_classic()
```
## AUC

```{r auc}
auc <- purrr::map_dfr(
  results, function(.i){
    purrr::map_dfc(
      .i[,-c(1:2)], ~{
        pROC::roc(.i$Y_true, .x) %>% suppressWarnings() %>% .$auc %>% as.numeric()})}) %>% 
  tidyr::pivot_longer(cols = everything(), names_to = "Method", values_to = "AUC") %>% 
  mutate(Analysis = case_when(stringr::str_detect(Method, "log")~"FLR", TRUE~"RF"),
         Method = factor(Method, levels = c(meth))
        )

auc %>% 
  ggplot(aes(x = Method, y = AUC, fill = Analysis)) +
  geom_boxplot() +
  scale_x_discrete(breaks = meth, labels = meth_lab) +
  scale_fill_manual(values = meth_col) +
  theme_classic()
```

# Table

## Average performance

```{r average}
cali %>% 
  cbind(AUC = auc$AUC) %>% 
  cbind(RMSE = rmse$RMSE) %>% 
  cbind(Brier = brier$Brier) %>% 
  group_by(Method) %>% 
  summarise(across(everything()[-3], mean)) %>%
  write.table(file = "table_perf.csv", sep = ",")
```

